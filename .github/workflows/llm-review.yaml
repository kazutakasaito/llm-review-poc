name: LLM Review

on:
  pull_request:
    types: [opened, edited, synchronize]
    paths: # ç‰¹å®šã®ãƒ‘ã‚¹é…ä¸‹ã® .md ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ™‚ã®ã¿ãƒˆãƒªã‚¬ãƒ¼
      - 'pbis/**/*.md' # ä¾‹: 'pbis' ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®å…¨ã¦ã® .md ãƒ•ã‚¡ã‚¤ãƒ«
      - 'user_stories/**/*.md' # ä»–ã®ãƒ‘ã‚¹ã‚‚è¿½åŠ å¯èƒ½

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã«å¿…è¦
      contents: read # actions/checkout ã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å…¨å±¥æ­´ã‚’ãƒ•ã‚§ãƒƒãƒ

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # requirements.txt ã« langchain-openai, langgraph, openai ãªã©ã‚’è¨˜è¼‰
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # å€‹åˆ¥ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å ´åˆ
          # pip install langchain-openai langgraph openai

      - name: Get changed markdown files
        id: changed_files
        run: |
          # PRã®ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã¨ãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒã®é–“ã®å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          # å¯¾è±¡ã¯ on.pull_request.paths ã§æŒ‡å®šã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆè‡´ã™ã‚‹ .md ãƒ•ã‚¡ã‚¤ãƒ«
          # (ã‚ˆã‚Šå³å¯†ã«ã¯ã€ã“ã“ã§å†åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã‚‚è‰¯ã„)
          files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- '*.md' | grep -E '^(pbis/|user_stories/).*\.md$' || true)
          if [ -z "$files" ]; then
            echo "No markdown files changed in specified paths."
            echo "changed_files_list=''" >> $GITHUB_OUTPUT
          else
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ãƒªã‚¹ãƒˆåŒ–
            echo "changed_files_list<<EOF" >> $GITHUB_OUTPUT
            echo "$files" | tr '\n' ' ' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Changed markdown files: $files"
          fi

      - name: Run multi-persona review if files changed
        if: steps.changed_files.outputs.changed_files_list != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Running review for files: ${{ steps.changed_files.outputs.changed_files_list }}"
          # ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã™
          # xargs ã‚’ä½¿ã£ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒç©ºã§ãªã„å ´åˆã®ã¿å®Ÿè¡Œã™ã‚‹
          # shellcheck disable=SC2086
          echo ${{ steps.changed_files.outputs.changed_files_list }} | xargs python llm_review/reviewer_agents.py > review_results.json
          echo "Review results generated in review_results.json"
          cat review_results.json # ãƒ‡ãƒãƒƒã‚°ç”¨ã«å†…å®¹ã‚’å‡ºåŠ›

      - name: Format review results to Markdown
        id: format_review
        if: steps.changed_files.outputs.changed_files_list != ''
        shell: python
        run: |
          import json
          import os

          output_path = os.getenv('GITHUB_OUTPUT')
          markdown_output = ""
          try:
            with open('review_results.json', 'r', encoding='utf-8') as f:
              results = json.load(f)
          except FileNotFoundError:
            print("review_results.json not found.")
            results = []
          except json.JSONDecodeError:
            print("Failed to decode review_results.json.")
            results = []

          if not results:
            markdown_output = "LLMã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®PBIãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‹ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
          else:
            markdown_output += "ğŸ“ **LLMã«ã‚ˆã‚‹PBIãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ**\n\n"
            for file_result in results:
              file_path = file_result.get("file_path", "N/A")
              error = file_result.get("error")
              review = file_result.get("review", {})

              markdown_output += f"### ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: `{file_path}`\n"
              if error:
                markdown_output += f"**ã‚¨ãƒ©ãƒ¼:** {error}\n\n"
                continue
              if not review:
                markdown_output += "æŒ‡æ‘˜äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\n"
                continue

              for persona, comments in review.items():
                if comments: # ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ãƒšãƒ«ã‚½ãƒŠã®ã¿è¡¨ç¤º
                  markdown_output += f"#### ğŸ§‘â€ğŸ’» ãƒšãƒ«ã‚½ãƒŠ: {persona.capitalize()}\n"
                  if not comments: # JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ãªã©ã§ç©ºã®å ´åˆ
                      markdown_output += "- æŒ‡æ‘˜äº‹é …ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n"
                      continue
                  for comment_item in comments:
                    severity = comment_item.get('severity', 'N/A').upper()
                    comment_text = comment_item.get('comment', 'ã‚³ãƒ¡ãƒ³ãƒˆãªã—')
                    line = comment_item.get('line')
                    
                    line_info = f" (è¡Œ: {line})" if line is not None else ""
                    
                    emoji = "âš ï¸" # Default
                    if severity == 'HIGH':
                        emoji = "ğŸ”´"
                    elif severity == 'MEDIUM':
                        emoji = "ğŸŸ¡"
                    elif severity == 'LOW':
                        emoji = "ğŸŸ¢"
                    elif severity == 'ERROR':
                        emoji = "â—"

                    markdown_output += f"- **{emoji} [{severity}]{line_info}:** {comment_text}\n"
                  markdown_output += "\n"
            if not any(file_result.get("review") for file_result in results if not file_result.get("error")):
                 markdown_output += "\nå…¨ä½“ã¨ã—ã¦ã€å…·ä½“çš„ãªæŒ‡æ‘˜äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n"


          # GITHUB_OUTPUT ã«æ›¸ãè¾¼ã‚€ (é•·ã™ãã‚‹å ´åˆã¯æ³¨æ„)
          # Markdown ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚‹
          # ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ç›´æ¥ä»£å…¥
          with open(output_path, 'a') as f:
              f.write(f"markdown_comment<<EOF\n{markdown_output}\nEOF\n")
          print("Markdown comment prepared.")
          # print(f"Formatted Markdown:\n{markdown_output}") # For debugging

      - name: Post comment to PR
        if: steps.changed_files.outputs.changed_files_list != '' && steps.format_review.outputs.markdown_comment != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          # review_results.json ã®ä»£ã‚ã‚Šã«æ•´å½¢ã—ãŸMarkdownã‚’æ¸¡ã™
          # header: llm-review # ã‚³ãƒ¡ãƒ³ãƒˆã«ä¸€æ„ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã—ã¦æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          # message: ${{ steps.format_review.outputs.markdown_comment }}
          # GITHUB_TOKEN ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§åˆ©ç”¨å¯èƒ½
          # path ã®ä»£ã‚ã‚Šã« message ã‚’ä½¿ç”¨
          header: llm-review-results # æ›´æ–°ç”¨ã®ä¸€æ„ãªID
          message: |
            ${{ steps.format_review.outputs.markdown_comment }}

      - name: No files to review
        if: steps.changed_files.outputs.changed_files_list == ''
        run: echo "No markdown files to review in specified paths. Skipping LLM review."

